name: Monitor CNJ

on:
  schedule:
    - cron: '*/30 * * * *'  # Executa a cada 30 minutos
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do repositÃ³rio
      uses: actions/checkout@v2

    - name: Instalar dependÃªncias do sistema para o Puppeteer
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libxss1 \
          libasound2t64

    - name: Instalar dependÃªncias Node.js
      run: npm install puppeteer xlsx axios form-data

    - name: Executar monitoramento com Puppeteer
      id: monitor
      run: |
        rm -f scripts/monitor_flag.txt
        node scripts/monitor-puppeteer.js

        if [ -f scripts/monitor_flag.txt ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Enviar mensagem de alerta
      if: steps.monitor.outputs.has_changes == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        node scripts/send_telegram.js $'ðŸš¨ AlteraÃ§Ã£o detectada no painel CNJ!\n\nBaixe o arquivo em anexo para verificar as mudanÃ§as.'

    - name: Enviar arquivo .xlsx via Telegram
      if: steps.monitor.outputs.has_changes == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        node scripts/send_telegram_file.js

    - name: Salvar artefatos (Ãºltimo XLSX e diff)
      if: steps.monitor.outputs.has_changes == 'true'
      uses: actions/upload-artifact@vmain
      with:
        name: relatorio-cnjs
        path: |
          scripts/downloads/tabela_atual.xlsx
          scripts/diff_table.txt
