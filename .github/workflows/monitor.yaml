name: Monitor CNJ

on:
  schedule:
    - cron: '*/30 * * * *'  # Executa a cada 30 minutos
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do repositÃ³rio
      uses: actions/checkout@v2

    - name: Instalar dependÃªncias do sistema para o Puppeteer
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libxss1 \
          libasound2t64

    - name: Instalar Puppeteer (sem package.json)
      run: npm install puppeteer

    - name: Rodar monitor com Puppeteer
      id: monitor
      run: |
        rm -f scripts/monitor_flag.txt
        node scripts/monitor-puppeteer.js

        if [ -f scripts/monitor_flag.txt ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Enviar alerta se houver alteraÃ§Ã£o
      if: steps.monitor.outputs.has_changes == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        node scripts/send_telegram.js "ðŸš¨ AlteraÃ§Ã£o detectada no painel CNJ!\n\nAcesse: https://paineisanalytics.cnj.jus.br/single/?appid=b532a1c7-3028-4041-80e2-9620527bd3fa&sheet=fb006575-35ca-4ccd-928c-368edd2045ba&theme=cnj_theme&opt=ctxmenu&select=Ramo%20de%20justi%C3%A7a,Trabalho&select=Ano,&select=tribunal_proces"

    - name: Salvar tabela e diff
      if: steps.monitor.outputs.has_changes == 'true'
      uses: actions/upload-artifact@main
      with:
        name: dados-tabela-cnjs
        path: |
          scripts/last_table_data.txt
          scripts/prev_table_data.txt
          scripts/diff_table.txt
