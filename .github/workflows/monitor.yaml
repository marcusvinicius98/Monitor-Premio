name: Monitor CNJ VBA-Style

on:
  schedule:
    - cron: '*/30 * * * *'  # Executa a cada 30 minutos
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do repositório
      uses: actions/checkout@v2

    - name: Instalar dependências de sistema para Puppeteer
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libxss1 \
          libasound2t64

    - name: Instalar dependências do Node.js
      run: |
        cd scripts
        npm install

    - name: Executar monitoramento
      id: monitor
      run: |
        rm -f scripts/monitor_flag.txt
        node scripts/monitor-puppeteer.js

        if [ -f scripts/monitor_flag.txt ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Enviar arquivo de diferenças via Telegram
      if: steps.monitor.outputs.has_changes == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        node scripts/send_telegram_file.js

    - name: Salvar artefatos do workflow
      if: steps.monitor.outputs.has_changes == 'true'
      uses: actions/upload-artifact@main
      with:
        name: Diferencas_CNJ
        path: scripts/downloads/Diferencas_CNJ.xlsx
